<div id="tp-board-game">
  <div class="tp-game-container">
    <div class="tp-board-wrapper">
      <div class="tp-board">
        <img src="img/00_ConenctorBoard.png" class="tp-board-base" alt="Connector Board">
        <img src="img/01_FemaleHeaderPins_12P.png" class="tp-ghost-component" id="tp-ghost" alt="Target placement">
        <!-- Placed components will be added here -->
      </div>
    </div>
    
    <div class="tp-step-indicator">
      <span class="tp-step-text">Step 1 of 7: Place the Female Header Pins (12P)</span>
    </div>
    
    <div class="tp-tray">
      <img src="img/pickup/01_FemaleHeaderPins_12P.png" 
           class="tp-component" 
           data-id="01_FemaleHeaderPins_12P"
           data-full-src="img/01_FemaleHeaderPins_12P.png"
           data-order="1"
           alt="Female Header Pins 12P">
      <img src="img/pickup/02_FemaleHeaderPins_16p.png" 
           class="tp-component tp-hidden" 
           data-id="02_FemaleHeaderPins_16p"
           data-full-src="img/02_FemaleHeaderPins_16p.png"
           data-order="2"
           alt="Female Header Pins 16P">
      <img src="img/pickup/03_MaleHeaderPins_12P.png" 
           class="tp-component tp-hidden" 
           data-id="03_MaleHeaderPins_12P"
           data-full-src="img/03_MaleHeaderPins_12P.png"
           data-order="3"
           alt="Male Header Pins 12P">
      <img src="img/pickup/04_MaleHeaderPins_16P.png" 
           class="tp-component tp-hidden" 
           data-id="04_MaleHeaderPins_16P"
           data-full-src="img/04_MaleHeaderPins_16P.png"
           data-order="4"
           alt="Male Header Pins 16P">
      <img src="img/pickup/05_ePulseFeather.png" 
           class="tp-component tp-hidden" 
           data-id="05_ePulseFeather"
           data-full-src="img/05_ePulseFeather.png"
           data-order="5"
           alt="ePulse Feather">
      <img src="img/pickup/06_PowerSwitch.png" 
           class="tp-component tp-hidden" 
           data-id="06_PowerSwitch"
           data-full-src="img/06_PowerSwitch.png"
           data-order="6"
           alt="Power Switch">
      <img src="img/pickup/07_GroveConnector.png" 
           class="tp-component tp-hidden" 
           data-id="07_GroveConnector"
           data-full-src="img/07_GroveConnector.png"
           data-order="7"
           alt="Grove Connector">
      <img src="img/pickup/11_Sticker1.png" 
           class="tp-component tp-hidden" 
           data-id="11_Sticker1"
           data-full-src="img/11_Sticker1.png"
           data-order="8"
           alt="Sticker 1">
      <img src="img/pickup/12_Sticker2.png" 
           class="tp-component tp-hidden" 
           data-id="12_Sticker2"
           data-full-src="img/12_Sticker2.png"
           data-order="9"
           alt="Sticker 2">
      <img src="img/pickup/13_Sticker3.png" 
           class="tp-component tp-hidden" 
           data-id="13_Sticker3"
           data-full-src="img/13_Sticker3.png"
           data-order="10"
           alt="Sticker 3">
      <img src="img/pickup/14_Sticker4.png" 
           class="tp-component tp-hidden" 
           data-id="14_Sticker4"
           data-full-src="img/14_Sticker4.png"
           data-order="11"
           alt="Sticker 4">
      <img src="img/pickup/15_Display.png" 
           class="tp-component tp-hidden" 
           data-id="15_Display"
           data-full-src="img/15_Display.png"
           data-order="12"
           alt="Display">
    </div>
    
    <div class="tp-completion tp-hidden">
      <p class="tp-completion-text">Nice! You've just built the whole board. This is exactly what you'll do with the real Color Kit.</p>
      <button class="tp-completion-btn">Build it for real</button>
    </div>
  </div>
</div>

<style>
  #tp-board-game {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
    max-width: 500px;
    margin: 0 auto;
    padding: 20px;
    box-sizing: border-box;
  }
  
  #tp-board-game * {
    box-sizing: border-box;
  }
  
  .tp-game-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 20px;
  }
  
  .tp-board-wrapper {
    position: relative;
    width: 100%;
    max-width: 400px;
  }
  
  .tp-board {
    position: relative;
    width: 100%;
    aspect-ratio: 1;
    background: #f5f5f5;
    border: 3px solid #333;
    border-radius: 8px;
    overflow: hidden;
  }
  
  .tp-board-base {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    object-fit: contain;
    z-index: 1;
    pointer-events: none;
  }
  
  .tp-ghost-component {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    object-fit: contain;
    z-index: 200;
    pointer-events: none;
    opacity: 0.6;
    filter: brightness(0) invert(1);
    animation: tp-pulse 2s ease-in-out infinite;
    mix-blend-mode: screen;
  }
  
  @keyframes tp-pulse {
    0%, 100% {
      opacity: 0.6;
    }
    50% {
      opacity: 0.8;
    }
  }
  
  @keyframes tp-flicker {
    0%, 100% {
      opacity: 1;
    }
    10% {
      opacity: 0.2;
    }
    20% {
      opacity: 1;
    }
    30% {
      opacity: 0.4;
    }
    40% {
      opacity: 1;
    }
    50% {
      opacity: 0.1;
    }
    60% {
      opacity: 1;
    }
    70% {
      opacity: 0.6;
    }
    80% {
      opacity: 1;
    }
    90% {
      opacity: 0.3;
    }
  }
  
  .tp-step-indicator {
    text-align: center;
    padding: 10px;
    background: #e8f4f8;
    border-radius: 6px;
    width: 100%;
    max-width: 400px;
  }
  
  .tp-step-text {
    font-size: 14px;
    font-weight: 600;
    color: #2c5aa0;
  }
  
  .tp-tray {
    position: relative;
    width: 100%;
    max-width: 400px;
    min-height: 150px;
    padding: 20px;
    background: #fff;
    border: 2px dashed #ccc;
    border-radius: 8px;
    display: flex;
    justify-content: center;
    align-items: center;
  }
  
  .tp-component {
    max-width: 150px;
    max-height: 150px;
    width: auto;
    height: auto;
    object-fit: contain;
    cursor: grab;
    transition: transform 0.2s ease, opacity 0.2s ease;
    touch-action: none;
    user-select: none;
    -webkit-user-select: none;
  }
  
  .tp-component:active {
    cursor: grabbing;
  }
  
  .tp-component.tp-dragging {
    position: fixed;
    z-index: 1000;
    opacity: 0.8;
    pointer-events: none;
  }
  
  .tp-component.tp-placed {
    position: absolute;
    top: 0 !important;
    left: 0 !important;
    width: 100% !important;
    height: 100% !important;
    max-width: none !important;
    max-height: none !important;
    object-fit: contain;
    cursor: default;
    opacity: 1;
  }
  
  .tp-component.tp-hidden {
    display: none;
  }
  
  .tp-completion {
    text-align: center;
    padding: 20px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 8px;
    width: 100%;
    max-width: 400px;
    animation: tp-fadeIn 0.5s ease;
  }
  
  .tp-completion.tp-hidden {
    display: none;
  }
  
  .tp-completion-text {
    color: white;
    font-size: 16px;
    line-height: 1.5;
    margin: 0 0 15px 0;
  }
  
  .tp-completion-btn {
    background: white;
    color: #667eea;
    border: none;
    padding: 12px 24px;
    font-size: 16px;
    font-weight: 600;
    border-radius: 6px;
    cursor: pointer;
    transition: transform 0.2s ease;
  }
  
  .tp-completion-btn:hover {
    transform: scale(1.05);
  }
  
  @keyframes tp-fadeIn {
    from {
      opacity: 0;
      transform: translateY(-10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
  
  @media (max-width: 480px) {
    #tp-board-game {
      padding: 10px;
    }
    
    .tp-component {
      width: 80px;
      height: 80px;
    }
    
    .tp-tray {
      min-height: 100px;
      padding: 15px;
    }
  }
</style>

<script>
(function() {
  const componentOrder = [
    { id: '01_FemaleHeaderPins_12P', name: 'Female Header Pins (12P)', order: 1 },
    { id: '02_FemaleHeaderPins_16p', name: 'Female Header Pins (16P)', order: 2 },
    { id: '03_MaleHeaderPins_12P', name: 'Male Header Pins (12P)', order: 3 },
    { id: '04_MaleHeaderPins_16P', name: 'Male Header Pins (16P)', order: 4 },
    { id: '05_ePulseFeather', name: 'ePulse Feather', order: 5 },
    { id: '06_PowerSwitch', name: 'Power Switch', order: 6 },
    { id: '07_GroveConnector', name: 'Grove Connector', order: 7 },
    { id: '11_Sticker1', name: 'Sticker 1', order: 8 },
    { id: '12_Sticker2', name: 'Sticker 2', order: 9 },
    { id: '13_Sticker3', name: 'Sticker 3', order: 10 },
    { id: '14_Sticker4', name: 'Sticker 4', order: 11 },
    { id: '15_Display', name: 'Display', order: 12 }
  ];
  
  let currentStep = 1;
  let draggedElement = null;
  let startX = 0;
  let startY = 0;
  let offsetX = 0;
  let offsetY = 0;
  let originalParent = null;
  let originalIndex = 0;
  
  const board = document.querySelector('.tp-board');
  const boardBase = document.querySelector('.tp-board-base');
  const tray = document.querySelector('.tp-tray');
  const stepText = document.querySelector('.tp-step-text');
  const completion = document.querySelector('.tp-completion');
  const ghostComponent = document.getElementById('tp-ghost');
  
  function updateStepIndicator() {
    if (currentStep <= componentOrder.length) {
      const currentComponent = componentOrder[currentStep - 1];
      stepText.textContent = `Step ${currentStep} of ${componentOrder.length}: Place the ${currentComponent.name}`;
    }
  }
  
  function updateGhostComponent() {
    if (currentStep <= componentOrder.length) {
      const currentComponent = componentOrder[currentStep - 1];
      ghostComponent.src = `img/${currentComponent.id}.png`;
      ghostComponent.style.zIndex = '200';
      ghostComponent.style.display = 'block';
    } else {
      ghostComponent.style.display = 'none';
    }
  }
  
  function showCurrentComponent() {
    const components = tray.querySelectorAll('.tp-component');
    components.forEach(comp => {
      const order = parseInt(comp.dataset.order);
      if (order === currentStep) {
        comp.classList.remove('tp-hidden');
      } else if (!comp.classList.contains('tp-placed')) {
        comp.classList.add('tp-hidden');
      }
    });
  }
  
  function handlePointerDown(e) {
    const component = e.target;
    if (!component.classList.contains('tp-component') || component.classList.contains('tp-placed')) {
      return;
    }
    
    const order = parseInt(component.dataset.order);
    if (order !== currentStep) {
      return;
    }
    
    e.preventDefault();
    
    draggedElement = component;
    originalParent = component.parentElement;
    
    const rect = component.getBoundingClientRect();
    const pointerX = e.clientX || e.touches?.[0]?.clientX || 0;
    const pointerY = e.clientY || e.touches?.[0]?.clientY || 0;
    
    offsetX = pointerX - rect.left;
    offsetY = pointerY - rect.top;
    startX = rect.left;
    startY = rect.top;
    
    component.classList.add('tp-dragging');
    component.style.left = rect.left + 'px';
    component.style.top = rect.top + 'px';
    component.style.width = rect.width + 'px';
    component.style.height = rect.height + 'px';
    
    document.addEventListener('pointermove', handlePointerMove);
    document.addEventListener('pointerup', handlePointerUp);
  }
  
  function handlePointerMove(e) {
    if (!draggedElement) return;
    
    e.preventDefault();
    
    const pointerX = e.clientX || e.touches?.[0]?.clientX || 0;
    const pointerY = e.clientY || e.touches?.[0]?.clientY || 0;
    
    draggedElement.style.left = (pointerX - offsetX) + 'px';
    draggedElement.style.top = (pointerY - offsetY) + 'px';
  }
  
  function handlePointerUp(e) {
    if (!draggedElement) return;
    
    e.preventDefault();
    
    document.removeEventListener('pointermove', handlePointerMove);
    document.removeEventListener('pointerup', handlePointerUp);
    
    const pointerX = e.clientX || e.changedTouches?.[0]?.clientX || 0;
    const pointerY = e.clientY || e.changedTouches?.[0]?.clientY || 0;
    
    const boardRect = board.getBoundingClientRect();
    
    const isOverBoard = (
      pointerX >= boardRect.left &&
      pointerX <= boardRect.right &&
      pointerY >= boardRect.top &&
      pointerY <= boardRect.bottom
    );
    
    if (isOverBoard) {
      placeComponent(draggedElement);
    } else {
      snapBack(draggedElement);
    }
    
    draggedElement = null;
  }
  
  function placeComponent(component) {
    // Switch to full-size image when placing on board
    const fullSrc = component.dataset.fullSrc;
    if (fullSrc) {
      component.src = fullSrc;
    }
    
    component.classList.remove('tp-dragging');
    component.classList.add('tp-placed');
    component.style.position = 'absolute';
    component.style.top = '0';
    component.style.left = '0';
    component.style.width = '100%';
    component.style.height = '100%';
    
    const order = parseInt(component.dataset.order);
    component.style.zIndex = order + 1;
    
    board.appendChild(component);
    
    currentStep++;
    
    // Check if we just placed the Grove Connector (step 7)
    if (order === 7) {
      setTimeout(() => {
        flipBoardToBack();
        // Update UI after flip animation completes (1.6s total)
        setTimeout(() => {
          if (currentStep <= componentOrder.length) {
            updateStepIndicator();
            updateGhostComponent();
            showCurrentComponent();
          }
        }, 1600);
      }, 500);
    } else if (currentStep > componentOrder.length) {
      showCompletion();
    } else {
      updateStepIndicator();
      updateGhostComponent();
      showCurrentComponent();
    }
  }
  
  function snapBack(component) {
    component.classList.remove('tp-dragging');
    component.style.position = '';
    component.style.left = '';
    component.style.top = '';
    component.style.width = '';
    component.style.height = '';
    
    if (originalParent && originalParent.contains(component) === false) {
      originalParent.appendChild(component);
    }
  }
  
  function flipBoardToBack() {
    // Hide ghost component during transition
    ghostComponent.style.display = 'none';
    
    // Add flip animation
    board.style.transition = 'transform 0.8s ease-in-out';
    board.style.transformStyle = 'preserve-3d';
    board.style.transform = 'rotateY(180deg)';
    
    setTimeout(() => {
      // Hide all front-side components (orders 1-7)
      const placedComponents = board.querySelectorAll('.tp-component.tp-placed');
      placedComponents.forEach(comp => {
        const order = parseInt(comp.dataset.order);
        if (order <= 7) {
          comp.style.display = 'none';
        }
      });
      
      // Switch to back board image
      boardBase.src = 'img/10_ConnectorBoard.png';
      board.style.transform = 'rotateY(360deg)';
      
      setTimeout(() => {
        board.style.transition = '';
        board.style.transform = '';
        updateGhostComponent();
      }, 800);
    }, 800);
  }
  
  function showDisplayOn() {
    // Hide the ghost component
    ghostComponent.style.display = 'none';
    
    // Create display on overlay
    const displayOn = document.createElement('img');
    displayOn.src = 'img/16_DisplayOn.png';
    displayOn.style.position = 'absolute';
    displayOn.style.top = '0';
    displayOn.style.left = '0';
    displayOn.style.width = '100%';
    displayOn.style.height = '100%';
    displayOn.style.objectFit = 'contain';
    displayOn.style.zIndex = '300';
    displayOn.style.opacity = '0';
    displayOn.style.animation = 'tp-flicker 2s ease-in-out';
    
    board.appendChild(displayOn);
    
    // Remove flicker animation after it completes and keep display on
    setTimeout(() => {
      displayOn.style.animation = '';
      displayOn.style.opacity = '1';
    }, 2000);
  }
  
  function showCompletion() {
    showDisplayOn();
    
    setTimeout(() => {
      completion.classList.remove('tp-hidden');
      stepText.textContent = 'Assembly Complete!';
    }, 2500);
  }
  
  function init() {
    updateStepIndicator();
    updateGhostComponent();
    showCurrentComponent();
    
    const components = document.querySelectorAll('.tp-component');
    components.forEach(comp => {
      comp.addEventListener('pointerdown', handlePointerDown);
    });
  }
  
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }
})();
</script>
